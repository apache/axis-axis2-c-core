name: Dependency CVE Check

on:
  schedule:
    # Run monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  check-cves:
    runs-on: ubuntu-latest
    name: Check CVEs for Axis2/C Dependencies

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check NVD for dependency CVEs
        id: cve-check
        run: |
          echo "# Axis2/C Dependency CVE Report" > cve-report.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M UTC')" >> cve-report.md
          echo "" >> cve-report.md

          # Dependencies to check (from docs/SECURITY.md)
          DEPS="openssl libxml2 json-c nghttp2 apache-http-server expat apr"

          for dep in $DEPS; do
            echo "Checking $dep..."
            echo "## $dep" >> cve-report.md
            echo "" >> cve-report.md

            # Query NVD API (public, no key needed for low volume)
            response=$(curl -s "https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=$dep&resultsPerPage=10" || echo '{"error": true}')

            if echo "$response" | jq -e '.vulnerabilities' > /dev/null 2>&1; then
              echo "$response" | jq -r '
                .vulnerabilities[]? |
                "- **\(.cve.id)** (\(.cve.published[0:10])): \(.cve.descriptions[0].value[0:150])..."
              ' >> cve-report.md 2>/dev/null || echo "- No recent CVEs found" >> cve-report.md
            else
              echo "- Unable to query NVD API" >> cve-report.md
            fi

            echo "" >> cve-report.md

            # Rate limit: NVD allows 5 requests per 30 seconds without API key
            sleep 7
          done

          echo "" >> cve-report.md
          echo "---" >> cve-report.md
          echo "*Review docs/SECURITY.md minimum versions and update if needed.*" >> cve-report.md

          cat cve-report.md

      - name: Upload CVE Report
        uses: actions/upload-artifact@v4
        with:
          name: cve-report
          path: cve-report.md
          retention-days: 90

      - name: Create Issue if Critical CVEs Found
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('cve-report.md', 'utf8');

            // Check if report contains CVEs (not just "No recent CVEs")
            const hasCVEs = report.includes('CVE-') && !report.includes('No recent CVEs found');

            if (hasCVEs) {
              // Check for existing open issue
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'security,dependencies',
                state: 'open'
              });

              const existingIssue = issues.data.find(i =>
                i.title.includes('Monthly Dependency CVE Report')
              );

              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `Monthly Dependency CVE Report - ${new Date().toISOString().slice(0,7)}`,
                  body: report,
                  labels: ['security', 'dependencies']
                });
                console.log('Created new CVE report issue');
              } else {
                console.log('CVE report issue already exists, skipping');
              }
            } else {
              console.log('No significant CVEs found, no issue created');
            }
